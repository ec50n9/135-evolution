
// ==UserScript==
// @name        微信编辑器增强🧬(dev)
// @namespace   http://tampermonkey.net/
// @match       *://www.135editor.com/*
// @match       *://bj.96weixin.com/*
// @match       *://www.365editor.com/*
// @icon        https://www.135editor.com/img/vip/vip.png
// @require     https://cdn.jsdelivr.net/npm/jscolor-picker@2.0.4/jscolor.min.js
// @grant       GM_addStyle
// @version     1.8
// @author      ec50n9
// @description 为135、96、365编辑器去除广告，免vip，增加css样式编辑面板等...
// @license     MIT
// ==/UserScript==
      (()=>{"use strict";console.log("--- inject ---"),GM_addStyle('#ec_window {\n  display: flex;\n  flex-direction: column;\n  position: fixed;\n  top: 5%;\n  left: 25%;\n  width: 24em;\n  max-height: 90%;\n  background-color: #fff;\n  box-shadow: rgba(9, 30, 66, 0.25) 0px 4px 8px -2px,\n    rgba(9, 30, 66, 0.08) 0px 0px 0px 1px;\n  border-radius: 1em;\n  overflow: hidden;\n  z-index: 999;\n  font-family: PingFangSC-Regular, "Georgia Pro", Georgia, Times,\n    "Times New Roman", sans-serif;\n}\n#ec_path_list {\n  list-style: none;\n  display: flex;\n  flex-wrap: wrap;\n  text-transform: lowercase;\n}\n#ec_path_list li:nth-child(n + 2)::before {\n  content: ">";\n  margin: 0 0.5em;\n}\n#ec_win_style th,\n#ec_win_attr th {\n  width: 40%;\n  border-width: 1px;\n  font-weight: 500;\n}\n.header {\n  position: relative;\n  padding: 0.2rem 0;\n  color: #000;\n  font-weight: 700;\n  background-color: #fff;\n  cursor: move;\n  user-select: none;\n}\n.header__title {\n  text-align: center;\n}\n.header__btns-wrapper {\n  position: absolute;\n  top: 50%;\n  left: 0;\n  transform: translateY(-40%);\n}\n.header__btn {\n  display: inline-block;\n  width: 0.9em;\n  height: 0.9em;\n  margin-left: 0.5em;\n  background-color: #fff;\n  border: none;\n  border-radius: 50%;\n  cursor: pointer;\n}\n#ec_win_close {\n  background-color: rgb(239, 68, 68);\n}\n#ec_win_mini {\n  background-color: rgb(245, 158, 11);\n}\n.tab-wrapper {\n  display: flex;\n  flex-direction: row;\n}\n.tab {\n  flex-grow: 1;\n  color: rgb(107, 114, 128);\n  font-size: 0.9rem;\n  padding: 0.2rem 0;\n  margin: 0.3rem;\n  text-align: center;\n  border-radius: 0.5rem;\n  cursor: pointer;\n}\n.tab--active {\n  color: #fff;\n  font-weight: 700;\n  background-color: rgb(16, 185, 129);\n  box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;\n}\n#ec_panel_wrapper {\n  display: flex;\n  overflow: hidden;\n}\n#ec_panel_element {\n  display: flex;\n  width: 100%;\n  flex-direction: column;\n  margin: 1em;\n  overflow: hidden;\n}\n#ec_win_html {\n  width: 100%;\n  resize: none;\n  box-sizing: border-box;\n}\n\n#ec_panel_color,\n#ec_panel_template {\n  width: 100%;\n  margin: 2em;\n}\n\n#color_picker {\n  width: 100%;\n  display: flex;\n  flex-direction: column;\n}\n#color_color {\n  position: relative;\n  width: 100%;\n  height: 10em;\n  background-color: rgb(255, 0, 0);\n}\n#color_sat {\n  width: 100%;\n  height: 100%;\n  background-image: linear-gradient(to right, #fff, rgba(204, 154, 129, 0));\n}\n#color_val {\n  width: 100%;\n  height: 100%;\n  background-image: linear-gradient(to top, #000, rgba(204, 154, 129, 0));\n}\n#color_dragger {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 1em;\n  height: 1em;\n  transform: translate(-50%, -50%);\n  border-radius: 50%;\n  background-color: #fff;\n  border: 2px solid #000;\n}\n#color_h {\n  position: relative;\n  width: 100%;\n  height: 1em;\n  margin: 0.5em 0;\n  background: -webkit-linear-gradient(\n    left,\n    #ff0000 0%,\n    #ffff00 17%,\n    #00ff00 33%,\n    #00ffff 50%,\n    #0000ff 67%,\n    #ff00ff 83%,\n    #ff0000 100%\n  );\n}\n#color_alpha {\n  position: relative;\n  width: 100%;\n  height: 1em;\n  margin: 0.5em 0;\n  background-image: url(https://s1.ax1x.com/2022/04/17/LN6aCR.png);\n}\n#color_h_dragger,\n#color_alpha_dragger {\n  position: absolute;\n  top: -10%;\n  left: 100%;\n  width: 0.5em;\n  height: 120%;\n  transform: translateX(-50%);\n  background-color: #d1d5db;\n}\n#color_alpha_inner {\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0)\n    linear-gradient(to right, rgba(255, 0, 0, 0), rgb(255, 0, 0)) repeat scroll\n    0% 0%;\n}\n#color_preview_wrapper {\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  width: 100%;\n  margin: 1em 0;\n}\n#color_preview {\n  width: 2em;\n  height: 2em;\n  background-color: rgb(0, 0, 0);\n  border: 2px solid #eee;\n}\n#color_preview_text {\n  flex-grow: 1;\n  width: 1em;\n  margin-left: 1em;\n  border: 2px solid #eee;\n  padding: 0.1em 0.5em;\n  border-radius: 0.5em;\n}\n#color_copy {\n  align-self: flex-end;\n  padding: 0.2em 0.8em;\n  border-radius: 0.4em;\n  border: 2px solid #eee;\n  color: #fff;\n  background-color: #3b82f6;\n}\n');let e=$('<div id="ec_window">\n  <div id="ec_header" class="header">\n    <div class="header__title truncate">编辑面板</div>\n    <div class="header__btns-wrapper">\n      <div id="ec_win_close" class="header__btn"></div>\n      <div id="ec_win_mini" class="header__btn"></div>\n    </div>\n  </div>\n  <div id="ec_tabs" class="tab-wrapper">\n    <div id="ec_tab_element" class="tab tab--active">元素</div>\n    <div id="ec_tab_color" class="tab">色板</div>\n    <div id="ec_tab_template" class="tab">模板</div>\n  </div>\n  <div id="ec_panel_wrapper">\n    <div id="ec_panel_element" class="ec_panel">\n      <div id="ec_path_list"></div>\n      <div style="display:flex; flex-direction:column; overflow-y:scroll;">\n        <h2 style="margin-top:1em; font-weight:600">当前元素样式</h2>\n        <table id="ec_win_style"></table>\n        <div style="display:flex; align-items:center; margin-top:.5em">\n          <input id="ec_win_input_style" type="text" value="" placeholder="例: color: red;"\n            style="flex-grow:1; border:2px solid #eee;padding:0 8px; border-radius:2px;">\n          <button id="ec_win_add_style"\n            style="min-width:5em; margin-left:1em; padding:.2em .8em; border-radius:.4em; border:2px solid #eee; color:#fff; background-color:#3B82F6;">添加样式</button>\n        </div>\n        <div style="display:none; margin-top:.8em; color:#999; font-size:.8em;">\n          每次只能添加<strong>一条</strong>样式。<br>\n          添加样式后需要点击下方<strong>写入</strong>才可生效。<br>\n          清空编辑框后点击<strong>写入</strong>即可删除该行样式。\n        </div>\n        <h2 style="margin-top:1em; font-weight:600">属性</h2>\n        <table id="ec_win_attr"></table>\n        <h2 style="margin-top:1em; font-weight:600">子元素</h2>\n        <ul id="ec_child_list" style="margin:0;">\n        </ul>\n        <h2 style="margin-top:1em; font-weight:600">内容</h2>\n        <div style="width:100%">\n          <textarea id="ec_win_html" rows="5"\n            style="width:100%; border:2px solid #eee; padding:0 8px; border-radius:2px;">元素文本</textarea>\n        </div>\n      </div>\n      <div style="display:flex; flex-direction: row; align-items: center; justify-content: right;">\n        <button id="ec_win_delete"\n          style="align-self:flex-end; padding:.2em .8em; border-radius:.4em; border:2px solid #eee; color:#fff; background-color:#B91C1C;">删除元素</button>\n        <button id="ec_win_parent"\n          style="align-self:flex-end; padding:.2em .8em; border-radius:.4em; border:2px solid #eee; color:#fff; background-color:#F59E0B;">父容器</button>\n        <button id="ec_win_write"\n          style="align-self:flex-end; padding:.2em .8em; border-radius:.4em; border:2px solid #eee; color:#fff; background-color:#3B82F6;">更新写入</button>\n      </div>\n    </div>\n    <div id="ec_panel_color" class="ec_panel">\n      <h2>调色板</h2>\n      <div id="color_picker">\n        <div id="color_color">\n          <div id="color_sat">\n            <div id="color_val">\n              <div id="color_dragger"></div>\n            </div>\n          </div>\n        </div>\n        <div id="color_h">\n          <div id="color_h_dragger"></div>\n        </div>\n        <div id="color_alpha">\n          <div id="color_alpha_inner">\n            <div id="color_alpha_dragger"></div>\n          </div>\n        </div>\n        <div id="color_preview_wrapper">\n          <div id="color_preview"></div>\n          <input id="color_preview_text" type="text" placeholder="点击色板以选择颜色值">\n        </div>\n        <button id="color_copy">复制颜色值</button>\n      </div>\n    </div>\n    <div id="ec_panel_template" class="ec_panel">\n      <h2>开发中。。。</h2>\n    </div>\n  </div>\n</div>').hide();const n=e.find("#ec_header"),t=(e.find("#ec_win_close"),e.find("#ec_win_mini")),i=e.find("#ec_tabs"),o=e.find("#ec_tab_element"),r=e.find("#ec_tab_color"),l=e.find("#ec_tab_template"),a=e.find("#ec_panel_wrapper"),d=e.find("#ec_panel_element"),c=e.find("#ec_panel_color").hide(),s=e.find("#ec_panel_template").hide(),f=e.find("#ec_path_list"),p=e.find("#ec_win_style"),h=e.find("#ec_win_input_style"),g=e.find("#ec_win_add_style"),u=e.find("#ec_win_attr"),_=e.find("#ec_child_list"),m=e.find("#ec_win_html"),b=e.find("#ec_win_delete"),v=e.find("#ec_win_parent"),w=e.find("#ec_win_write");t.click((function(){i.toggle(),a.toggle()})),o.click((function(){console.log("gogo:",e.find(".tab--active")),e.find(".tab--active").removeClass("tab--active"),o.addClass("tab--active"),e.find(".ec_panel:not(#ec_panel_element)").hide(),d.show()})),r.click((function(){e.find(".tab--active").removeClass("tab--active"),r.addClass("tab--active"),e.find(".ec_panel:not(#ec_panel_color)").hide(),c.show()})),l.click((function(){e.find(".tab--active").removeClass("tab--active"),l.addClass("tab--active"),e.find(".ec_panel:not(#ec_panel_template)").hide(),s.show()}));const x=function(e){const n=$(e.target);$("#ueditor_0").contents().find("body .ective").removeClass("ective"),n.addClass("ective"),f.html(""),p.html(""),u.html(""),m.val(""),g.unbind(),_.html(""),w.unbind(),v.unbind(),b.unbind(),n.each((function(){n.parents().filter("body *").each((function(){let e=$(`<li><a style="color:#ff793f;" href="javascript:;">${this.tagName}</a></li>`);f.prepend(e);let n=$(this);e.find("a").bind("click",(function(){n.click()}))})),f.append(`<li>[ ${this.tagName} ]</li>`),$.each(this.attributes,(function(){if(this.specified)if("style"===this.name){let e=this.value.split(";");for(let n=0;n<e.length;n++){let t=e[n];if(t){let e=t.split(":"),n=t.slice(t.indexOf(":")+1).trim(),i=$(`<tr ec-attr="${e[0]}"><th>${e[0]}</th><td><input type="${n.match(/^#[a-f0-9]{3,6}$/i),"text"}" value="${n}" style="border:2px solid #eee;padding:0 8px; border-radius:2px;"></td></tr>`);p.append(i)}}}else{let e=$(`<tr ec-attr="${this.name}"><th>${this.name}</th><td><input type="text" value="${this.value}" style="border:2px solid #eee;padding:0 8px; border-radius:2px;"></td></tr>`);u.append(e)}}))}));const t=function(e,n,i){const o=$('<ul style="list-style-type:circle; margin-left:2em;"></ul>');n.children().each((function(){let e=$(`<li><a style="color:#ff793f;" href="javascript:;">${this.tagName}</a></li>`),n=$(this);e.find("a").bind("click",(function(){return n.click(),!1})),o.append(e),t(o,n,e)})),o.html()&&(e.append(o),i&&i.css("list-style-type","disc").on("click",(function(){o.slideToggle(200)})))};function i(e){let n=p.find("tr"),t="";for(let e=0;e<n.length;e++){let i=$(n[e]);i.find("input").val()&&(t=t+i.attr("ec-attr")+":"+i.find("input").val()+";")}e.attr("style",t)}return t(_,n),m.val(n.html()),g.bind("click",(function(){let e=h.val();if(e){let n=e.split(":");p.append(`<tr ec-attr="${n[0]}"><th>${n[0]}</th><td><input type="text" value="${n.length>1?n[1].replace(";",""):""}" style="border:2px solid #eee;padding:0 8px; border-radius:2px;"></td></tr>`),h.val(""),initShowTranslate()}i(n)})),w.bind("click",(function(){i(n);let e=u.find("tr");for(let t=0;t<e.length;t++){let i=$(e[t]);n.attr(i.attr("ec-attr"),i.find("input").val())}n.html(m.val())})),v.bind("click",(function(){n.parent().click()})),b.bind("click",(function(){let e=n.parent();n.remove(),e.click()})),!1},y=function(){const n=$("#ueditor_0");if(H(".ective{outline: 1.5px dashed red !important; outline-offset: 2px; position: relative;}",n.contents().find("head")),$(this).hasClass("running")){e.fadeOut(200),n.contents().find("body").unbind(),$(this).removeClass("running"),n.contents().find("body .ective").removeClass("ective");const t=$(this).find("#ec-change");(t.length?t:$(this)).css({"background-color":"#e8b004"}).text("编辑进化")}else{e.fadeIn(200),n.contents().find("body").bind("click",x),$(this).addClass("running");const t=$(this).find("#ec-change");(t.length?t:$(this)).css({"background-color":"#20a162"}).text("解除进化")}},k=e.find("#color_color"),C=e.find("#color_dragger"),M=e.find("#color_h"),N=e.find("#color_h_dragger"),F=e.find("#color_alpha"),j=e.find("#color_alpha_dragger"),z=e.find("#color_preview"),T=e.find("#color_preview_text"),X=e.find("#color_copy");let Y=0,B=0,I=0,W=1;function G(e,n,t,i){let o,r,l,a,d,c=0,s=0,f=0;switch(n<0&&(n=0),n>1&&(n=1),t<0&&(t=0),t>1&&(t=1),(e%=360)<0&&(e+=360),e/=60,o=Math.floor(e),r=e-o,l=t*(1-n),a=t*(1-n*r),d=t*(1-n*(1-r)),o){case 0:c=t,s=d,f=l;break;case 1:c=a,s=t,f=l;break;case 2:c=l,s=t,f=d;break;case 3:c=l,s=a,f=t;break;case 4:c=d,s=l,f=t;break;case 5:c=t,s=l,f=a}return i&&i<1?"rgba("+Math.round(255*c)+", "+Math.round(255*s)+", "+Math.round(255*f)+", "+i+")":"rgb("+Math.round(255*c)+", "+Math.round(255*s)+", "+Math.round(255*f)+")"}function P(e,n,t,i){e/=255,n/=255,t/=255;const o=Math.max(e,n,t),r=o-Math.min(e,n,t);let l=o,a=0===l?0:r/l,d=0;return e===l&&(d=60*(n-t)/r),n===l&&(d=120+60*(t-e)/r),t===l&&(d=240+60*(e-n)/r),0===r&&(d=0),d<0&&(d+=360),d=d/2/180,d=Number(d.toFixed(4)),a=Number(a.toFixed(4)),l=Number(l.toFixed(4)),[d,a,l,i]}function R(){const e=G(Y,B,I,W);z.css("background-color",e),T.val(e)}function S(n,t){n.mousedown((function(i){let o=i.pageX-n.offset().left,r=i.pageY-n.offset().top;return t(o,r),e.mousemove((function(e){o=e.pageX-n.offset().left,r=e.pageY-n.offset().top,t(o,r)})),e.mouseup((function(n){e.off("mousemove"),e.off("mouseup")})),e.mouseleave((function(n){e.off("mousemove"),e.off("mouseup")})),!1}))}T.change((function(){const e=T.val().trim();let n;if(e.match(/^#[a-f0-9]{3,8}$/i)){const{red:t,green:i,blue:o,alpha:r}=function(e){let n=e.substring(1),t=1;return n.length<6?n=function(e,n){let t="";for(let n of e)t+=i(n,2);return t}(n):8==n.length&&(t="0x"+n&"0xff",t=Number((t/255*1).toFixed(2)),n=n.substring(0,6)),n="0x"+n,{red:n>>16,green:n>>8&"0xff",blue:"0xff"&n,alpha:t};function i(e,n){let t="";for(let i=0;i<n;i++)t+=e;return t}}(e);n=P(t,i,o,r),R()}else if(e.match(/^rgba\(.+?\)$/i)){const t=e.replace(/\s+/g,"").match(/^rgba\(([0-9]+),([0-9]+),([0-9]+),([0-9.]+)\)$/i);n=P(t[1],t[2],t[3],t[4])}else{if(!e.match(/^rgb\(.+?\)$/i))return;{const t=e.replace(/\s+/g,"").match(/^rgb\(([0-9]+),([0-9]+),([0-9]+)\)$/i);n=P(t[1],t[2],t[3],1)}}Y=360*n[0],B=n[1],I=n[2],W=n[3],k.css("background-color",G(Y,1,1,1)),C.css({left:B*k.width()+"px",top:k.height()-I*k.height()}),N.css({left:Y*M.width()/360}),j.css({left:W*F.width()}),R()})),X.click((function(e){console.log("hello"),T.select(),document.execCommand("Copy")})),S(k,(function(e,n){e<0&&(e=0),e>k.width()&&(e=k.width()),n<0&&(n=0),n>k.height()&&(n=k.height()),C.css({left:e+"px",top:n+"px"}),B=e/k.width(),I=(k.height()-n)/k.height(),R()})),S(M,(function(e){e<0&&(e=0),e>M.width()&&(e=M.width()),N.css({left:e+"px"}),Y=~~(e/M.width()*360),k.css("background-color",G(Y,1,1,1)),R()})),S(F,(function(e){e<0&&(e=0),e>F.width()&&(e=F.width()),j.css({left:e+"px"}),W=Number((e/F.width()).toFixed(2)),R()}));const H=function(e,n){(n||$("head")).append($(`<style>${e}</style>`))};$((function(){$("body").append(e),n.mousedown((function(n){var t=e.offset(),i=n.pageX-t.left,o=n.pageY-t.top;return $(document).mousemove((function(n){var t=n.pageX-i,r=n.pageY-o;t<0?t=0:t>$(document).width()-e.outerWidth(!0)&&(t=$(document).width()-e.outerWidth(!0)),r<0?r=0:r>$(document).height()-e.outerHeight(!0)&&(r=$(document).height()-e.outerHeight(!0)),e.css({left:t+"px",top:r+"px"})})),$(document).mouseup((function(){$(document).off("mousemove")})),!1})),H("#ec-change{color:#fff; background-color:#e8b004;}");const t=window.location.host;t.search(/www.135editor.com/)>=0?function(){setInterval((()=>{let e=$("#editor-template-scroll li");for(let n=0,t=e.length;n<t;n++)e[n].classList.remove("vip-style");$(".vip-flag").remove(),$(".user-unread-msgnum").hide();try{articleManager.setVIP(!0)}catch(e){}}),1e3),unsafeWindow.style_click=unsafeWindow.show_role_vip_dialog=function(){console.log("hey!")},style_click=show_role_vip_dialog=function(){},$("#add_xiaoshi").hide(),$(".category-nav.editor-nav>.nav-item:nth-last-child(-n+2)").hide(),$("#fixed-side-bar li:not(#function-settings), #fixed-bar-pack-up").hide();let e=$('<li style="margin-bottom: 20px;"><a href="javascript:;" id="ec-change" class="btn btn-default btn-xs" title="绑定监听器">编辑进化</a></li>').on("click",y);$("#operate-tool").prepend(e);let n=$('<li><a href="javascript:;" class="btn btn-default btn-xs" title="打开色板">开关色板</a></li>').on("click",(function(){$("#color-plan").fadeToggle(300)}));$("#operate-tool").prepend(n)}():t.search(/bj.96weixin.com/)>=0?function(){setInterval((()=>{$(".rich_media_content").attr("data-vip",1)}),1e3);let e=$('<button type="button" id="ec-change" class="layui-btn layui-btn-primary">编辑进化</button>').on("click",y);$(".button-tools").prepend(e)}():t.search(/www.365editor.com/)>=0&&function(){let e=$('<li id="ec-change" data-act="import"><span>编辑进化</span></li>').on("click",y);$(".m-tools").prepend(e)}()})),console.log("--- inject end ---")})();